import{a as i,V as D,b as K,j as e,M as V,r as s,U as Y,c as N}from"./app-D7li6CLM.js";import{A as X,B as Z}from"./AuthenticatedLayout-DMfk2MtA.js";import{S as ee}from"./react-select.esm-B35sbcdT.js";import{U as ae}from"./UseAppUrl-B-nOq47X.js";import{u as O}from"./useQuery-sgCDjop0.js";const ge=({collectors:se,generated_bill_no:E})=>{const h=ae(),[m,$]=i.useState(null),[n,M]=i.useState({}),[f,L]=i.useState(""),U=async({queryKey:a})=>{const[r,t,d,c,u]=a;return(await N.get(`${h}/api/customers/transactions`,{params:{page:t,search:d,sortColumn:c,sortDirection:u}})).data},F=async({queryKey:a})=>{const[r,t,d,c,u]=a;return u?(await N.get(`${h}/api/customers/transactions`,{params:{page:t,search:u,sortColumn:d,sortDirection:c}})).data:{data:[],current_page:1}},{customers:b}=D().props,[H,re]=i.useState(""),[v,te]=i.useState((b==null?void 0:b.current_page)||1),[p,le]=i.useState({column:"",direction:"asc"}),{customer_transactions:x}=D().props;i.useState(""),i.useState((x==null?void 0:x.current_page)||1),i.useState({column:"",direction:"asc"});const{data:g,error:ne,isLoading:_,refetch:ie}=O({queryKey:["customers",v,H,p.column,p.direction],queryFn:U,keepPreviousData:!0}),{data:j,isTransLoading:oe,refetch:q}=O({queryKey:["customer-transactions",v,p.column,p.direction,m],queryFn:F,enabled:!!m,keepPreviousData:!0}),[S,C]=i.useState(!1),w=()=>C(!S),[T,P]=i.useState(!1),y=()=>{P(!T)},{data:l,setData:o,post:ce,errors:de,reset:me,processing:z}=K({customer_plan_id:"",bill_no:E,rebate:"",partial:"",bill_amount:"",remarks:"",status:""}),W=async a=>{var t,d;if(a.preventDefault(),!l.customer_plan_id||Number(l.customer_plan_id)<=0){alert("Please select a customer.");return}if(!((t=l.remarks)!=null&&t.trim())){alert("Choose a billing type.");return}if(!l.partial||Number(l.partial)<=0){alert("Partial payment is required");return}if(!((d=l.status)!=null&&d.trim())){alert("Status is required.");return}const r={...l,bill_amount:Number(l.bill_amount)||0,rebate:Number(l.rebate)||0,partial:Number(l.partial)||0};try{console.log("Form data to submit:",JSON.stringify(r,null,2));const c=await N.post(`${h}/api/transactions`,r);console.log("Response:",c.data),P(!0),o("bill_amount",""),q()}catch(c){console.error("Error creating transaction:",c.response||c),alert("Failed to create transaction. Check console for details.")}},J=["Month","Bill Noww.","Bill Amount","Status"],A=["Acc No.","Customer Name","Status"],B=[{value:"paid",label:"Paid"},{value:"unpaid",label:"Unpaid"}],I=(g==null?void 0:g.data.map(a=>({id:a.id,customer_name:`${a.lastname} ${a.firstname} ${a.middlename??""}`,firstname:a.firstname,middlename:a.middlename,lastname:a.lastname,address:a.address,contact_no:a.contact_no,sex:a.sex,marital_status:a.marital_status,birthdate:a.birthdate,occupation:a.occupation,status:a.status,plans:a.customer_plans.map(r=>({mbps:r.plan.mbps,plan_price:r.plan.plan_price,date_registration:r.date_registration,customer_plan_id:r.id}))})))||[],k=(j==null?void 0:j.data.map(a=>({id:a.id,customer_name:`${a.lastname} ${a.firstname} ${a.middlename??""}`,firstname:a.firstname,middlename:a.middlename,lastname:a.lastname,address:a.address,contact_no:a.contact_no,sex:a.sex,marital_status:a.marital_status,birthdate:a.birthdate,occupation:a.occupation,status:a.status,plans:a.customer_plans.map(r=>({customer_plan_id:r.id,mbps:r.plan.mbps,plan_price:r.plan.plan_price,date_registration:r.date_registration,transactions:r.transactions.map(t=>({id:t.id,bill_no:t.bill_no,rebate:Number(t.rebate)||0,partial:Number(t.partial)||0,bill_amount:Number(t.bill_amount)||0,remarks:t.remarks,status:t.status,created_at:t.created_at,updated_at:t.updated_at}))}))})))||[];i.useEffect(()=>{m!==null&&alert(`Selected Customer: ${n.customer_name}`)},[m,n]);const G=a=>{const r=a.plans[0]||{};$(a.id),o("customer_plan_id",r.customer_plan_id),M({customer_name:`${a.firstname} ${a.lastname}`,customer_plan_id:r.customer_plan_id,mbps:r.mbps||"N/A",plan_price:r.plan_price||"N/A",date_registration:r.date_registration||"N/A"}),C(!1)},R=a=>{const r=a.target.value;L(r),o("remarks",r)};return e.jsxs(X,{children:[e.jsx(V,{title:"Create New Bill"}),e.jsxs("div",{className:"bg-white overflow-y-auto max-h-[590px] grid place-justify-center ",children:[e.jsxs("div",{className:"flex justify-between mt-5 mb-2 px-4",children:[e.jsxs("div",{className:"flex gap-10",children:[e.jsx(s.Radio,{name:"type",label:"Advance Billing",value:"advance",checked:f==="advance",onChange:R}),e.jsx(s.Radio,{name:"type",label:"Batch Billing",value:"batch",checked:f==="batch",onChange:R})]}),e.jsx(s.Tooltip,{content:"Back",children:e.jsx(Y,{href:"/batch_bills",className:"hover:bg-gray-200 px-2 py-1 rounded",children:e.jsx(Z,{className:"text-xl cursor-pointer"})})})]}),e.jsxs(s.Dialog,{open:T,handler:y,size:"lg",children:[e.jsx(s.DialogHeader,{children:"Billing Notice"}),e.jsx(s.DialogBody,{children:e.jsxs("div",{className:"relative bg-gray-100 p-6 rounded shadow h-[480px] overflow-auto",children:[e.jsx("div",{className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rotate-[-30deg]
                text-green-800 font-bold text-6xl border-2 border-green-800
  px-8 py-4 opacity-40 select-none pointer-events-none
                whitespace-nowrap inline-block`,children:"CFS NOTICE PAID"}),e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("img",{src:"/img/internet.png",alt:"CFS Logo",className:"w-16 h-16"}),e.jsxs("div",{className:"text-sm mt-1",children:["#2, Manguelod Bldg. National High Way",e.jsx("br",{}),"District II, Tumauini, Isabela",e.jsx("br",{}),"TIN: 295-973-965-001",e.jsx("br",{}),"CP#: 09453367030"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-bold",children:"Wesly Ivan Gaffud"}),e.jsx("p",{children:"August 1, 2025"})]})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{children:"Acct. No:"}),e.jsx("span",{children:"1258"})]}),e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("span",{children:"Bill No."}),e.jsx("span",{children:"2510000"})]}),e.jsxs("div",{className:"space-y-1 mb-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Bill for the month of August"}),e.jsx("span",{children:"₱800.00"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Rebate"}),e.jsx("span",{children:"₱0.00"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Partial"}),e.jsx("span",{children:"₱0.00"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Outstanding Balance Previous Month"}),e.jsx("span",{children:"₱300.00"})]}),e.jsxs("div",{className:"flex justify-between font-bold border-t border-gray-400 pt-2",children:[e.jsx("span",{children:"Amount Due:"}),e.jsx("span",{children:"₱1,100.00"})]})]}),e.jsxs("div",{className:"flex justify-between text-sm mb-4",children:[e.jsx("span",{children:"Prepared by: John"}),e.jsx("span",{children:"Collector: John Robert Linerto"}),e.jsx("span",{children:"Date:"})]}),e.jsxs("div",{className:"border border-red-500 p-3 rounded text-sm bg-red-50 flex items-start gap-2",children:[e.jsx("div",{className:"text-red-600 font-bold",children:"⚠"}),e.jsxs("div",{children:[e.jsx("p",{children:"7 Days Notice: To avoid temporary disconnection kindly settle your bill within 7 days of the due date. For assistance or to make a payment please call:"}),e.jsx("p",{className:"font-bold",children:"CUSTOMER SERVICE NO: 09453367030"}),e.jsx("p",{className:"font-bold",children:"BILLING DEPT. CP NO: 09162832206"})]})]})]})}),e.jsxs(s.DialogFooter,{children:[e.jsx(s.Button,{variant:"text",color:"red",onClick:y,className:"mr-2",children:"Cancel"}),e.jsx(s.Button,{variant:"gradient",color:"green",onClick:y,children:"Print"})]})]}),e.jsxs("div",{className:"flex justify-between items-center px-4",children:[e.jsxs("div",{className:"flex gap-6 px-4",children:[e.jsxs(s.Typography,{variant:"h6",color:"blue-gray",children:["ACC NO.:"," ",e.jsx("span",{className:"text-orange-900",children:m})]}),e.jsxs(s.Typography,{variant:"h6",color:"blue-gray",children:["CUSTOMER:"," ",e.jsx("span",{className:"text-orange-900",children:(n==null?void 0:n.customer_name)||""})]}),e.jsxs(s.Typography,{variant:"h6",color:"blue-gray",children:["PLAN:"," ",e.jsx("span",{className:"text-orange-900",children:n&&n.mbps?`${n.mbps} mbps - ${new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(n.plan_price)}`:""})]}),e.jsxs(s.Typography,{variant:"h6",color:"blue-gray",children:["REGISTRATION:"," ",e.jsx("span",{className:"text-orange-900",children:n.date_registration})]}),e.jsxs(s.Typography,{variant:"h6",color:"blue-gray",children:["BALANCE OF JULY:"," ",e.jsx("span",{className:"text-orange-900",children:"1.5m"})]})]}),e.jsxs("div",{children:[e.jsx(s.Button,{onClick:w,variant:"gradient",children:"New Bill"}),e.jsx(s.Dialog,{open:S,handler:w,children:e.jsx(s.DialogBody,{children:e.jsxs(s.Card,{className:"h-[480px] w-full overflow-scroll",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(s.Typography,{variant:"h6",color:"blue-gray",children:"SEARCH CUSTOMER"}),e.jsx("input",{className:"w-96 bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded-md pl-3 pr-10 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-300 shadow-sm focus:shadow",placeholder:"Search lastname..."})]}),e.jsxs("table",{className:"w-full min-w-max table-auto text-left",children:[e.jsx("thead",{children:e.jsx("tr",{children:A.map(a=>e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:e.jsx(s.Typography,{variant:"small",color:"blue-gray",className:"font-normal leading-none opacity-70",children:a})},a))})}),e.jsx("tbody",{children:_?e.jsx("tr",{children:e.jsx("td",{colSpan:A.length,className:"border border-blue-gray-100 p-4",children:e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(s.Spinner,{className:"h-10 w-10",color:"green"})})})}):I.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:J.length,className:"border border-blue-gray-100 p-4 text-center text-red-500",children:e.jsxs("div",{className:"flex justify-center items-center gap-2",children:["No customer records found",e.jsx(CgDanger,{className:"text-xl"})]})})}):I.map(a=>{const{id:r,customer_name:t,status:d,plans:c}=a;return e.jsxs("tr",{className:"hover:bg-blue-gray-50 cursor-pointer",onClick:()=>G(a),children:[e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(s.Typography,{variant:"small",className:"font-normal text-gray-800",children:r})}),e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(s.Typography,{variant:"small",className:"font-normal text-gray-800",children:t})}),e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(s.Typography,{variant:"small",className:"font-normal text-gray-800",children:d})})]},r)})})]})]})})})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-1",children:[e.jsxs("div",{className:"w-full lg:w-[60%] h-[480px] overflow-auto p-4 border-2 border-sky-500",children:[e.jsx(s.Typography,{variant:"h6",color:"blue-gray",children:"ALL TRANSACTION"}),e.jsxs("table",{className:"w-full min-w-max table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Month"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Bill No"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Bill Amount"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Remarks"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Status"})]})}),e.jsx("tbody",{children:_?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"border p-4",children:e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(s.Spinner,{className:"h-10 w-10",color:"green"})})})}):k.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"border p-4 text-center text-red-500",children:"No transaction records found"})}):k.map(a=>a.plans.flatMap(r=>r.transactions.map(t=>e.jsxs("tr",{className:"hover:bg-blue-gray-50",children:[e.jsx("td",{className:"border px-4 py-2",children:new Date(t.created_at).toLocaleDateString("en-US")}),e.jsx("td",{className:"border px-4 py-2",children:t.bill_no}),e.jsx("td",{className:"border px-4 py-2",children:new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(t.bill_amount)}),e.jsx("td",{className:"border px-4 py-2",children:t.remarks}),e.jsx("td",{className:"border px-4 py-2",children:t.status})]},t.id))))})]})]}),e.jsx("div",{className:"w-full lg:w-[35%] p-4 overflow-auto shadow-md rounded-md border-2 border-sky-500",children:e.jsxs("form",{onSubmit:W,children:[e.jsx("input",{type:"hidden",value:l.customer_plan_id,onChange:a=>o("customer_plan_id",a.target.value),className:"mb-2"}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Acc No."}),e.jsx(s.Input,{size:"md",value:l.customer_plan_id,disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Bill No."}),e.jsx(s.Input,{size:"md",value:l.bill_no,disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Rebate"}),e.jsx(s.Input,{type:"number",size:"md",value:l.rebate||"",onChange:a=>{const r=Number(a.target.value),t=Number(n.plan_price);r>t?(alert(`Rebate cannot be greater than Plan Price (${t}).`),o("rebate",t)):o("rebate",r)},className:"mb-3",onWheel:a=>a.target.blur()})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Partial"}),e.jsx(s.Input,{type:"number",size:"md",value:l.partial||"",onChange:a=>{const r=Number(a.target.value),t=Number(n.plan_price);r>t?(alert(`Partial cannot be greater than Plan Price (${t}).`),o("partial",t)):o("partial",r)},className:"mb-3",onWheel:a=>a.target.blur()})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Total Amount Paid"}),e.jsx(s.Input,{type:"number",size:"md",value:Number(n.plan_price)-Number(l.rebate||0),onChange:a=>o("bill_amount",a.target.value),className:"mb-3",disabled:!0})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Outstanding Balance"}),e.jsx(s.Input,{size:"md",value:Number(l.partial)===Number(n.plan_price)?0:Math.max(0,Number(n.plan_price)-Number(l.rebate||0)-(Number(l.partial||0)+Number(l.bill_amount||0))),disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(s.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Status"}),e.jsx(ee,{options:B,placeholder:"Choose a status",value:B.find(a=>a.value===l.status),onChange:a=>o("status",a?a.value:""),className:"mb-3"})]}),e.jsx(s.Button,{type:"submit",disabled:z,color:"blue",fullWidth:!0,children:"Save"})]})})]})]})]})};export{ge as default};
