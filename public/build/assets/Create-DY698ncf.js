import{a as i,V as Q,b as ge,j as e,M as je,r as t,U as ye,c as x}from"./app-DWWUAkfN.js";import{C as Ne}from"./index-D07TOBYh.js";import{A as _e,B as fe}from"./AuthenticatedLayout-C-P1UnEi.js";import{S as ve}from"./react-select.esm-BRqe_9mR.js";import{U as we}from"./UseAppUrl-ByyfOBKj.js";import{u as X}from"./useQuery-H0Xqtlr4.js";import{d as Se}from"./dayjs.min-BGsJhQ3S.js";import{l as Te}from"./index-CeinICog.js";import{f as Y}from"./format-BzRktsyD.js";import"./NavLink-D3jshW23.js";import"./index-DsdxDG7N.js";const Ve=({collectors:Ce})=>{var E,O,$,L,F,U,H,z,W,q,R,G,K,V,J;const u=we(),[b,Z]=i.useState(null),[n,ee]=i.useState({}),[ae,re]=i.useState("batch"),[s,Be]=i.useState(null);i.useState("");const[f,te]=i.useState(""),[se,le]=i.useState(""),v=i.useRef(),ne=Te.useReactToPrint({contentRef:v}),ie=async({queryKey:a})=>{const[r,l,m,p,d]=a;return(await x.get(`${u}/api/customers/transactions`,{params:{page:l,search:m,sortColumn:p,sortDirection:d}})).data},ce=async({queryKey:a})=>{const[r,l,m,p,d]=a;return d?(await x.get(`${u}/api/customers/transactions`,{params:{page:l,search:d,sortColumn:m,sortDirection:p}})).data:{data:[],current_page:1}},{customers:g}=Q().props;i.useState("");const[w,Ae]=i.useState((g==null?void 0:g.current_page)||1),[h,Me]=i.useState({column:"",direction:"asc"}),{customer_transactions:j}=Q().props;i.useState(""),i.useState((j==null?void 0:j.current_page)||1),i.useState({column:"",direction:"asc"});const{data:y,error:Ie,isLoading:S,refetch:Pe}=X({queryKey:["customers",w,f,h.column,h.direction],queryFn:ie,keepPreviousData:!0}),{data:N,isTransLoading:De,refetch:ke}=X({queryKey:["customer-transactions",w,h.column,h.direction,b],queryFn:ce,enabled:!!b,keepPreviousData:!0}),[T,C]=i.useState(!1),B=()=>C(!T),[A,oe]=i.useState(!1),M=()=>{oe(!A)},de=async()=>{try{const a=await x.get(`${u}/api/transactions/generate-bill-no`);le(a.data.bill_no),o("bill_no",a.data.bill_no)}catch(a){console.error("Failed to fetch new bill number",a)}},{data:c,setData:o,post:Ee,errors:me,reset:Oe,processing:pe}=ge({customer_plan_id:"",collector_id:"",bill_no:se,rebate:"",partial:"",bill_amount:"",remarks:"batch",status:"",date_billing:""}),be=async a=>{a.preventDefault();const r=Number((n==null?void 0:n.plan_price)||0)-Number(c.rebate||0),l={...c,bill_amount:r,rebate:Number(c.rebate)||0,partial:Number(c.partial)||0};try{const p=(await x.post(`${u}/api/transactions`,l)).data.transaction.id;window.open(`/admin/transactions/print/${p}`,"_blank"),window.location.reload()}catch(m){console.error("Error creating transaction:",m.response||m),alert("Failed to create transaction. Check console for details.")}},ue=["Month","Bill Noww.","Bill Amount","Status"],I=["Acc No.","Customer Name","Status"],P=[{value:"paid",label:"Paid"},{value:"unpaid",label:"Unpaid"}],D=(y==null?void 0:y.data.map(a=>({id:a.id,customer_name:`${a.lastname} ${a.firstname} ${a.middlename??""}`,firstname:a.firstname,middlename:a.middlename,lastname:a.lastname,address:a.address,contact_no:a.contact_no,sex:a.sex,marital_status:a.marital_status,birthdate:a.birthdate,occupation:a.occupation,status:a.status,plans:a.customer_plans.map(r=>{const l=r.transactions.length?[...r.transactions].sort((d,_)=>new Date(_.created_at)-new Date(d.created_at))[0]:null;let m=null,p=null;return l&&(m=Number(l.bill_amount)-Number(l.partial),p=Se(l.created_at).format("MMMM")),{customer_plan_id:r.id,mbps:r.plan.mbps,plan_price:r.plan.plan_price,date_registration:r.date_registration,latest_balance:r.latest_balance,latest_balance_month:r.latest_balance_month,transactions:r.transactions.map(d=>({id:d.id,bill_no:d.bill_no,rebate:d.rebate,partial:d.partial,bill_amount:d.bill_amount,remarks:d.remarks,status:d.status,created_at:d.created_at})),last_transaction:l,balance:m,balanceMonth:p,collector_id:r.collector_id}})})))||[],k=(N==null?void 0:N.data.map(a=>({id:a.id,customer_name:`${a.lastname} ${a.firstname} ${a.middlename??""}`,firstname:a.firstname,middlename:a.middlename,lastname:a.lastname,address:a.address,contact_no:a.contact_no,sex:a.sex,marital_status:a.marital_status,birthdate:a.birthdate,occupation:a.occupation,status:a.status,plans:a.customer_plans.map(r=>({customer_plan_id:r.id,collector_id:r.collector_id,mbps:r.plan.mbps,plan_price:r.plan.plan_price,date_registration:r.date_registration,transactions:r.transactions.map(l=>({id:l.id,bill_no:l.bill_no,rebate:Number(l.rebate)||0,partial:Number(l.partial)||0,bill_amount:Number(l.bill_amount)||0,remarks:l.remarks,status:l.status,created_at:l.created_at,updated_at:l.updated_at}))}))})))||[];i.useEffect(()=>{de()},[]),i.useEffect(()=>{b!==null&&alert(`Selected Customer: ${n.customer_name}`)},[b,n]),i.useEffect(()=>{n!=null&&n.customer_plan_id&&o("customer_plan_id",n.customer_plan_id),n!=null&&n.collector_id&&o("collector_id",n.collector_id)},[n]);const he=a=>{const r=a.plans[0]||{};Z(a.id),o("customer_plan_id",r.customer_plan_id),o("collector_id",r.collector_id),ee({customer_name:`${a.firstname} ${a.lastname}`,customer_plan_id:r.customer_plan_id,mbps:r.mbps||"N/A",plan_price:r.plan_price||"N/A",date_registration:r.date_registration||"N/A",latest_balance:r.latest_balance||0,latest_balance_month:r.latest_balance_month||"N/A",collector_id:r.collector_id||""}),C(!1)},xe=a=>{const r=a.target.value;re(r),o("remarks",r)};return e.jsxs(_e,{children:[e.jsx(je,{title:"Create New Bill"}),e.jsxs("div",{className:"bg-white overflow-y-auto max-h-[590px] grid place-justify-center ",children:[e.jsxs("div",{className:"flex justify-between mt-5 mb-2 px-4",children:[e.jsx("div",{className:"flex gap-10",children:e.jsx(t.Radio,{name:"type",label:"Batch Billing",value:"batch",checked:ae==="batch",onChange:xe})}),e.jsx(t.Tooltip,{content:"Back",children:e.jsx(ye,{href:"/admin/transactions",className:"hover:bg-gray-200 px-2 py-1 rounded",children:e.jsx(fe,{className:"text-xl cursor-pointer"})})})]}),e.jsxs(t.Dialog,{open:A,handler:M,size:"lg",children:[e.jsx(t.DialogHeader,{children:"Billing Notice"}),e.jsx(t.DialogBody,{children:e.jsx("div",{className:"h-[480px] overflow-auto",children:e.jsxs("div",{ref:v,className:"relative  p-6 rounded shadow",children:[e.jsx("div",{className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rotate-[-30deg]
                text-green-800 font-bold text-6xl border-2 border-green-800
  px-8 py-4 opacity-40 select-none pointer-events-none
                whitespace-nowrap inline-block`,children:"CFS NOTICE PAID"}),e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("img",{src:"/img/internet.png",alt:"CFS Logo",className:"w-16 h-16"}),e.jsxs("div",{className:"text-sm mt-1",children:["#2, Manguelod Bldg. National High Way",e.jsx("br",{}),"District II, Tumauini, Isabela",e.jsx("br",{}),"TIN: 295-973-965-001",e.jsx("br",{}),"CP#: 09453367030"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-bold",children:s!=null&&s.customer?[(E=s.customer)==null?void 0:E.firstname,(O=s.customer)==null?void 0:O.middlename,($=s.customer)==null?void 0:$.lastname].filter(Boolean).join(" "):""}),e.jsx("p",{children:(L=s==null?void 0:s.transaction)!=null&&L.created_at?Y(new Date(s.transaction.created_at),"MMMM dd, yyyy"):""})]})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{children:"Acct. No:"}),e.jsx("span",{children:((U=(F=s==null?void 0:s.transaction)==null?void 0:F.customer_plan)==null?void 0:U.customer_id)??""})]}),e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("span",{children:"Bill No."}),e.jsx("span",{children:((H=s==null?void 0:s.transaction)==null?void 0:H.bill_no)??""})]}),e.jsxs("div",{className:"space-y-1 mb-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Bill for the month of August"}),e.jsxs("span",{children:["₱"," ",((z=s==null?void 0:s.transaction)==null?void 0:z.bill_amount)??"0.00"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Rebate"}),e.jsxs("span",{children:["₱"," ",((W=s==null?void 0:s.transaction)==null?void 0:W.rebate)??"0.00"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Partial"}),e.jsxs("span",{children:["₱"," ",((q=s==null?void 0:s.transaction)==null?void 0:q.partial)??"0.00"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Outstanding Balance Previous Month"}),e.jsxs("span",{children:["₱"," ",(s==null?void 0:s.outstanding_balance)??"0.00"]})]}),e.jsxs("div",{className:"flex justify-between font-bold border-t border-gray-400 pt-2",children:[e.jsx("span",{children:"Amount Due:"}),e.jsxs("span",{children:["₱"," ",((R=s==null?void 0:s.transaction)==null?void 0:R.bill_amount)??"0.00"]})]})]}),e.jsxs("div",{className:"flex justify-between text-sm mb-4",children:[e.jsx("span",{children:"Prepared by: John"}),e.jsxs("span",{children:["Collector:"," ",s!=null&&s.customer?[(G=s.collector)==null?void 0:G.firstname,(K=s.collector)==null?void 0:K.middlename,(V=s.collector)==null?void 0:V.lastname].filter(Boolean).join(" "):""]}),e.jsxs("span",{children:["Date:"," ",(J=s==null?void 0:s.transaction)!=null&&J.created_at?Y(new Date(s.transaction.created_at),"MMMM dd, yyyy"):""]})]}),e.jsxs("div",{className:"border border-red-500 p-3 rounded text-sm bg-red-50 flex items-start gap-2",children:[e.jsx("div",{className:"text-red-600 font-bold",children:"⚠"}),e.jsxs("div",{children:[e.jsx("p",{children:"7 Days Notice: To avoid temporary disconnection kindly settle your bill within 7 days of the due date. For assistance or to make a payment please call:"}),e.jsx("p",{className:"font-bold",children:"CUSTOMER SERVICE NO: 09453367030"}),e.jsx("p",{className:"font-bold",children:"BILLING DEPT. CP NO: 09162832206"})]})]})]})})}),e.jsxs(t.DialogFooter,{children:[e.jsx(t.Button,{variant:"text",color:"red",onClick:M,className:"mr-2",children:"Cancel"}),e.jsx(t.Button,{variant:"gradient",color:"green",onClick:()=>ne(),children:"Print"})]})]}),e.jsxs("div",{className:"flex justify-between items-center px-4",children:[e.jsxs("div",{className:"flex gap-6 px-4",children:[e.jsxs(t.Typography,{variant:"h6",color:"blue-gray",children:["ACC NO.:"," ",e.jsx("span",{className:"text-orange-900",children:b})]}),e.jsxs(t.Typography,{variant:"h6",color:"blue-gray",children:["CUSTOMER:"," ",e.jsxs("span",{className:"text-orange-900",children:[(n==null?void 0:n.customer_name)||"","-- ",(n==null?void 0:n.collector_id)||""]})]}),e.jsxs(t.Typography,{variant:"h6",color:"blue-gray",children:["PLAN:"," ",e.jsx("span",{className:"text-orange-900",children:n&&n.mbps?`${n.mbps} mbps - ${new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(n.plan_price)}`:""})]}),e.jsxs(t.Typography,{variant:"h6",color:"blue-gray",children:["REGISTRATION:"," ",e.jsx("span",{className:"text-orange-900",children:n.date_registration})]}),e.jsxs(t.Typography,{variant:"h6",color:"blue-gray",children:["BALANCE OF ",n.latest_balance_month,":"," ",e.jsx("span",{className:"text-orange-900",children:n.latest_balance})]})]}),e.jsxs("div",{children:[e.jsx(t.Button,{onClick:B,variant:"gradient",children:"New Bill"}),e.jsx(t.Dialog,{open:T,handler:B,children:e.jsx(t.DialogBody,{children:e.jsxs(t.Card,{className:"h-[480px] w-full overflow-scroll",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(t.Typography,{variant:"h6",color:"blue-gray",children:"SEARCH CUSTOMER"}),e.jsx("input",{className:"w-96 bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded-md pl-3 pr-10 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-300 shadow-sm focus:shadow",placeholder:"Search lastname...",value:f,onChange:a=>te(a.target.value)})]}),e.jsxs("table",{className:"w-full min-w-max table-auto text-left",children:[e.jsx("thead",{children:e.jsx("tr",{children:I.map(a=>e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:e.jsx(t.Typography,{variant:"small",color:"blue-gray",className:"font-normal leading-none opacity-70",children:a})},a))})}),e.jsx("tbody",{children:S?e.jsx("tr",{children:e.jsx("td",{colSpan:I.length,className:"border border-blue-gray-100 p-4",children:e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(t.Spinner,{className:"h-10 w-10",color:"green"})})})}):D.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:ue.length,className:"border border-blue-gray-100 p-4 text-center text-red-500",children:e.jsxs("div",{className:"flex justify-center items-center gap-2",children:["No customer records found",e.jsx(Ne,{className:"text-xl"})]})})}):D.map(a=>{const{id:r,customer_name:l,status:m,plans:p}=a;return e.jsxs("tr",{className:"hover:bg-blue-gray-50 cursor-pointer",onClick:()=>he(a),children:[e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(t.Typography,{variant:"small",className:"font-normal text-gray-800",children:r})}),e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(t.Typography,{variant:"small",className:"font-normal text-gray-800",children:l})}),e.jsx("td",{className:"border border-blue-gray-100 px-4 py-2 ",children:e.jsx(t.Typography,{variant:"small",className:"font-normal text-gray-800",children:m})})]},r)})})]})]})})})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-1",children:[e.jsxs("div",{className:"w-full lg:w-[60%] h-[480px] overflow-auto p-4 border-2 border-sky-500",children:[e.jsx(t.Typography,{variant:"h6",color:"blue-gray",children:"ALL TRANSACTION"}),e.jsxs("table",{className:"w-full min-w-max table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Month"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Bill No"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Partial"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Total Amount Paid"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Remarks"}),e.jsx("th",{className:"border-b border-blue-gray-100 bg-blue-gray-50 p-4",children:"Status"})]})}),e.jsx("tbody",{children:S?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"border p-4",children:e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(t.Spinner,{className:"h-10 w-10",color:"green"})})})}):k.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"border p-4 text-center text-red-500",children:"No transaction records found"})}):k.map(a=>a.plans.flatMap(r=>r.transactions.map(l=>e.jsxs("tr",{className:"hover:bg-blue-gray-50",children:[e.jsx("td",{className:"border px-4 py-2",children:new Date(l.created_at).toLocaleDateString("en-US")}),e.jsx("td",{className:"border px-4 py-2",children:l.bill_no}),e.jsx("td",{className:"border px-4 py-2",children:new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(l.partial)}),e.jsx("td",{className:"border px-4 py-2",children:new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(l.bill_amount)}),e.jsx("td",{className:"border px-4 py-2",children:l.remarks}),e.jsx("td",{className:"border px-4 py-2",children:l.status})]},l.id))))})]})]}),e.jsx("div",{className:"w-full lg:w-[35%] p-4 overflow-auto shadow-md rounded-md border-2 border-sky-500",children:e.jsxs("form",{onSubmit:be,children:[e.jsx("input",{type:"hidden",value:c.customer_plan_id,onChange:a=>o("customer_plan_id",a.target.value),className:"mb-2"}),e.jsx("input",{type:"hidden",value:c.collector_id,onChange:a=>o("collector__id",a.target.value),className:"mb-2"}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Acc No."}),e.jsx(t.Input,{size:"md",value:c.customer_plan_id,disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Bill No."}),e.jsx(t.Input,{size:"md",value:c.bill_no,disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Bill Amount"}),e.jsx(t.Input,{size:"md",value:n&&n.mbps?n.plan_price:"",disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Outstanding Balance Previous Month"}),e.jsx(t.Input,{size:"md",value:n.latest_balance,disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Rebate"}),e.jsx(t.Input,{type:"number",size:"md",value:c.rebate||"",onChange:a=>{const r=Number(a.target.value),l=Number(n.plan_price);r>l?(alert(`Rebate cannot be greater than Plan Price (${l}).`),o("rebate",l)):o("rebate",r)},className:"mb-3",onWheel:a=>a.target.blur()})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Total Amount Due"}),e.jsx(t.Input,{type:"number",size:"md",value:Number(n.plan_price)-Number(c.rebate||0),onChange:a=>o("bill_amount",a.target.value),className:"mb-3",disabled:!0})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Payment"}),e.jsx(t.Input,{type:"number",size:"md",value:c.partial||"",onChange:a=>{const r=Number(a.target.value),l=Number(n.plan_price)-Number(c.rebate||0);r>l?(alert(`Partial cannot be greater than Total Amount Paid (${l}).`),o("partial",l)):o("partial",r)},className:"mb-3",onWheel:a=>a.target.blur()})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Outstanding Balance"}),e.jsx(t.Input,{size:"md",value:Number(c.partial)===Number(n.plan_price)?0:Math.max(0,Number(n.plan_price)-Number(c.rebate||0)-(Number(c.partial||0)+Number(c.bill_amount||0))),disabled:!0,className:"mb-3"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Date Billing"}),e.jsx(t.Input,{size:"md",type:"date",value:c.date_billing,onChange:a=>o("date_billing",a.target.value),error:!!me.date_billing,className:"w-full"})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx(t.Typography,{variant:"paragraph",color:"blue-gray",className:"mb-1 ",children:"Status"}),e.jsx(ve,{options:P,placeholder:"Choose a status",value:P.find(a=>a.value===c.status),onChange:a=>o("status",a?a.value:""),className:"mb-3"})]}),e.jsx(t.Button,{type:"submit",disabled:pe,color:"blue",fullWidth:!0,children:"Save"})]})})]})]})]})};export{Ve as default};
